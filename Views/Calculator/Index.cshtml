@using CotizadorInterno.Web.Models
@using System.Text.Json
@{
    ViewData["Title"] = "Cotizador Interno";
    var seg = (UserSegment)(ViewData["Segment"] ?? UserSegment.Unknown);
    var isCorporate = seg == UserSegment.Corporate;
    var currentUser = (CurrentUserInfo?)(ViewData["CurrentUser"]) ?? new CurrentUserInfo();
     var storedScenarios = (IReadOnlyList<CotizadorInterno.Web.Models.Calculator.ScenarioStoredDto>?)ViewData["StoredScenarios"] ?? new List<CotizadorInterno.Web.Models.Calculator.ScenarioStoredDto>();
     var isAuthorizedSegment = seg == UserSegment.Super || seg == UserSegment.Corporate || seg == UserSegment.SMB;
}

<style>
    .pill {
        padding: 2px 10px;
        border-radius: 999px;
        border: 1px solid #e5e7eb;
        background: #f9fafb;
        font-size: 12px;
    }
    .seg-badge {
        padding: 2px 10px;
        border-radius: 999px;
        border: 1px solid #e5e7eb;
        background: #f3f4f6;
        font-size: 12px;
    }

    .scenario-tab {
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 10px 12px;
        background: #fff;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        min-width: 240px;
        box-shadow: 0 1px 2px rgba(0,0,0,.03);
    }
    .scenario-tab.active {
        border-color: #0d6efd;
        box-shadow: 0 0 0 4px rgba(13,110,253,.10);
    }
    .scenario-name {
        font-weight: 700;
        margin: 0;
        line-height: 1.1;
    }
    .scenario-sub {
        margin: 0;
        font-size: 12px;
        opacity: .75;
    }

    .type-chip {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 6px 10px;
        border-radius: 999px;
        border: 1px solid #e5e7eb;
        background: #fff;
        cursor: pointer;
        font-size: 12px;
        user-select: none;
    }
    .type-chip.active {
        border-color: #0d6efd;
        background: rgba(13,110,253,.08);
        font-weight: 700;
    }

    /* ✅ Buscador full width al escribir (panel de sugerencias) */
    .suggestions {
        border: 1px solid #e5e7eb;
        background: #fff;
        display: none;
        overflow: auto;

        position: fixed;
        left: 0;
        right: 0;
        width: 100vw;

        top: 0; /* se setea con JS */

        z-index: 3000;
        box-shadow: 0 12px 24px rgba(0,0,0,.10);
    }

    .suggestion-item {
        padding: 10px 14px;
        cursor: pointer;
        border-top: 1px solid #f3f4f6;
    }
    .suggestion-item:hover {
        background: #f9fafb;
    }

    .corp-bg, .corp-bg th {
        background: #fff7ed !important;
    }

    .table thead th {
        position: sticky;
        top: 0;
        background: #fff;
        z-index: 5;
    }

    .table-wrap {
        overflow: auto;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        background: #fff;
    }
    .totals-row td {
        font-weight: 800;
        background: #f9fafb;
        border-top: 2px solid #e5e7eb;
    }

    .soft-card {
        border: 1px solid #e5e7eb;
        border-radius: 14px;
        background: #fff;
        box-shadow: 0 1px 2px rgba(0,0,0,.03);
        padding: 14px;
    }
    .muted { opacity: .75; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

    /* ✅ Botón Calcular azul oscuro */
    .btn-calc-dark {
        background: #0b2a6f !important;
        border-color: #0b2a6f !important;
        color: #fff !important;
        font-weight: 700;
    }
    .btn-calc-dark:hover {
        background: #081f52 !important;
        border-color: #081f52 !important;
        color: #fff !important;
    }
    .btn-calc-dark:disabled {
        opacity: .75;
        cursor: not-allowed;
    }
     /* Modal aprovisionamiento */
    .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,.45);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 4000;
        padding: 20px;
    }
    .modal-card {
        background: #fff;
        border-radius: 12px;
        border: 1px solid #e5e7eb;
        box-shadow: 0 8px 30px rgba(0,0,0,.18);
        max-width: 640px;
        width: 100%;
        padding: 20px;
    }
     .debug-summary {
        font-size: 12px;
        color: #4b5563;
    }
    .debug-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 8px 16px;
    }
    .debug-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 12px;
    }
    .debug-table th,
    .debug-table td {
        border-bottom: 1px dashed #e5e7eb;
        padding: 4px 6px;
        text-align: left;
        vertical-align: top;
    }
    .debug-table th {
        color: #6b7280;
        font-weight: 600;
    }
    .debug-chip {
        display: inline-block;
        background: #f3f4f6;
        border-radius: 999px;
        padding: 2px 8px;
        font-size: 11px;
        font-weight: 600;
        color: #374151;
    }
    #attachmentModal {
        z-index: 4100;
    }
    .badge-soft {
        background: #eef2ff;
        color: #312e81;
        border-radius: 999px;
        padding: 4px 10px;
        font-size: 12px;
        font-weight: 700;
    }
    .status-msg {
        padding: 10px 12px;
        border-radius: 10px;
    }
    .status-success {
        background: #ecfdf3;
        border: 1px solid #a7f3d0;
        color: #065f46;
    }
    .status-error {
        background: #fef2f2;
        border: 1px solid #fecdd3;
        color: #991b1b;
    }
    .file-name {
        font-size: 12px;
        color: #6b7280;
    }
</style>

@if (!isAuthorizedSegment)
{
    <div class="alert alert-warning mt-3" role="alert">
        Tu usuario no tiene un segmento autorizado para usar esta aplicación. Por favor solicita autorización a
        <a href="mailto:sruiz@digitaltechcolombia.com">sruiz@digitaltechcolombia.com</a>.
    </div>
}
else
{

<div class="d-flex align-items-start justify-content-between gap-3 mb-3">
    <div>
        <h1 class="mb-1">Cotizador Interno</h1>
        <div class="d-flex align-items-center gap-2 flex-wrap">
            <span class="pill">Solo uso interno</span>
            <span class="seg-badge">Segmento: <strong>@seg</strong></span>
            @if (isCorporate)
            {
                <span class="seg-badge">Corporate UI</span>
            }
            else
            {
                <span class="seg-badge">SMB UI</span>
            }
        </div>
    </div>

    <div class="d-flex gap-2">
        <button id="btnNewScenario" class="btn btn-primary" type="button">Nuevo escenario</button>
        <button id="btnDuplicateScenario" class="btn btn-outline-secondary" type="button">Duplicar</button>
        <button id="btnDeleteScenario" class="btn btn-outline-danger" type="button">Eliminar</button>
    </div>
</div>

<!-- Escenarios -->
<div class="d-flex gap-2 flex-wrap mb-3" id="scenarioBar"></div>

<!-- Panel principal -->
<div class="soft-card">
    <div class="d-flex align-items-start justify-content-between gap-3 flex-wrap mb-2">
        <div style="min-width: 260px;">
            <label class="form-label fw-bold mb-1">Nombre del escenario</label>
            <input id="scenarioName" class="form-control" />
        </div>

        <div style="min-width: 520px;">
            <label class="form-label fw-bold mb-1">Tipo de negocio (agrega una línea marcando el tipo)</label>
            <div class="d-flex gap-2 flex-wrap" id="typeChips"></div>
            <div class="small muted mt-1">Selecciona un tipo para crear una nueva línea. Luego busca el producto.</div>
        </div>
    </div>

    <hr />

    <div class="table-wrap">
        <table class="table table-sm align-middle mb-0" style="min-width:@(isCorporate ? "1800px" : "1500px");">
            <thead>
                <tr>
                    <th style="width:110px;">Tipo</th>
                    <th style="width:680px;">Producto</th>
                    <th style="width:130px;">Costo UND</th>
                    <th style="width:110px;">Margen %</th>
                    <th style="width:150px;">Duración (meses)</th>
                    <th style="width:140px;">Venta UND</th>
                    <th style="width:110px;">Cantidad</th>
                    <th style="width:150px;">Venta Mensual</th>
                    <th style="width:140px;">Venta Total</th>

                    @if (isCorporate)
                    {
                        <th class="corp-bg" style="width:170px;">Desc. Corp UND</th>
                        <th class="corp-bg" style="width:170px;">Desc. Corp Mes</th>
                        <th class="corp-bg" style="width:170px;">Desc. Corp Año</th>
                        <th class="corp-bg" style="width:170px;">Ahorro Anual</th>
                    }

                    <th style="width:150px;">Precio Sugerido</th>
                    <th style="width:70px;"></th>
                </tr>
            </thead>
            <tbody id="linesBody"></tbody>
        </table>
    </div>

    <div class="small muted mt-2">
        Regla: si el nombre contiene <span class="mono">Prepaid</span> o <span class="mono">1 Year</span>, la duración queda fija en 12 meses (puedes usar prorrateo si aplica).
    </div>
</div>

<!-- Configuración inferior -->
<div class="soft-card mt-3">
    <div class="row g-3 align-items-end">
        <div class="col-md-4">
            <label class="form-label fw-bold">Tipo de negocio (negocio global)</label>
            <select id="dealType" class="form-select">
                <option value="0">ClienteNuevo</option>
                <option value="1">CrossSale</option>
                <option value="2">Renovación 1 vez</option>
                <option value="3">Renovación 2 veces</option>
                <option value="4">Renovación 3 veces o más</option>
            </select>
        </div>

        <div class="col-md-3">
            <label class="form-label fw-bold">¿Requiere prorrateo?</label>
            <select id="requiresProration" class="form-select">
                <option value="false">No</option>
                <option value="true">Sí</option>
            </select>
        </div>

        <div class="col-md-2">
            <label class="form-label fw-bold">Inicio</label>
            <input id="startDate" type="date" class="form-control" disabled />
        </div>

        <div class="col-md-2">
            <label class="form-label fw-bold">Final</label>
            <input id="endDate" type="date" class="form-control" disabled />
        </div>

        <div class="col-md-1 d-grid">
            <button id="btnCalculate" class="btn btn-calc-dark" type="button">Calcular</button>
        </div>
    </div>

    <div class="small muted mt-2" id="prorationHint" style="display:none;"></div>
</div>

<!-- Resultado abajo -->
<div class="soft-card mt-3">
    <div class="d-flex align-items-center justify-content-between mb-2">
        <h5 class="mb-0">Resultado</h5>
        <span class="pill">Solo visible</span>
    </div>

    <div class="row g-3">
        <div class="col-lg-4">
            <div class="muted">Puntaje total</div>
            <div id="resultPoints" style="font-size:36px; font-weight:900;">—</div>
        </div>

        <div class="col-lg-4">
            <div class="muted">Comisión final (COP)</div>
            <div id="resultCommission" style="font-size:30px; font-weight:900;">—</div>
        </div>

        <div class="col-lg-4">
            <div class="small muted">
                <div class="d-flex justify-content-between"><span>Segmento</span><span id="resultSegment">—</span></div>
                <div class="d-flex justify-content-between"><span>Prorrateo</span><span id="resultProration">—</span></div>
                <div class="d-flex justify-content-between"><span>Venta mensual</span><span id="resultMonthly">—</span></div>
                <div class="d-flex justify-content-between"><span>Venta total</span><span id="resultTotal">—</span></div>
            </div>

           <div class="d-flex gap-2 flex-wrap mt-3">
                <button id="btnExport" class="btn btn-outline-secondary" type="button">Exportar Excel</button>
                <button id="btnProvisioning" class="btn btn-primary" type="button">Solicitar Aprovisionamiento</button>
            </div>
            <div id="provisioningLog" class="small mt-2 text-muted"></div>
        </div>
    </div>
</div>

<!-- Modal adjunto -->
<div id="attachmentModal" class="modal-overlay" aria-hidden="true">
    <div class="modal-card" style="max-width: 520px;">
        <div class="d-flex justify-content-between align-items-start gap-2 mb-2">
            <div>
                <h6 class="mb-1">Adjuntar documento</h6>
                <div id="attachmentLabel" class="small text-muted">Adjuntar oferta autorizada o correo de aprobación</div>
            </div>
            <button type="button" class="btn btn-sm btn-outline-secondary" id="btnCloseAttachment">×</button>
        </div>
        <div class="mb-2">
            <input type="file" id="attachmentInput" class="form-control" accept=".pdf,.jpg,.jpeg,.doc,.docx" />
            <div id="attachmentFileName" class="file-name mt-1"></div>
            <div class="small text-muted mt-1">Formatos permitidos: PDF, JPG/JPEG, DOC/DOCX.</div>
        </div>
        <div id="attachmentStatus" class="status-msg mt-2" style="display:none;"></div>
        <div class="d-flex justify-content-end gap-2 mt-3">
            <button type="button" class="btn btn-outline-secondary" id="btnCancelAttachment">Cerrar</button>
        </div>
    </div>
</div>
<!-- Modal detalle cálculo (debug/test) -->
<div id="debugCalcModal" class="modal-overlay" aria-hidden="true">
    <div class="modal-card" style="max-width: 820px;">
        <div class="d-flex justify-content-between align-items-start gap-2 mb-2">
            <div>
                <h6 class="mb-1">Detalle de cálculo (debug)</h6>
                <div class="debug-summary">Solo para pruebas. Puedes comentar este bloque cuando todo esté validado.</div>
            </div>
            <button type="button" class="btn btn-sm btn-outline-secondary" id="btnCloseDebugCalc">×</button>
        </div>
        <div id="debugCalcContent" class="small"></div>
        <div class="d-flex justify-content-end gap-2 mt-3">
            <button type="button" class="btn btn-outline-secondary" id="btnCloseDebugCalcBottom">Cerrar</button>
        </div>
    </div>
</div>
<!-- Modal aprovisionamiento -->
<div id="provisioningModal" class="modal-overlay">
    <div class="modal-card">
        <div class="d-flex justify-content-between align-items-start gap-2 mb-2">
            <div>
                <div class="d-flex align-items-center gap-2 mb-1">
                    <h5 class="mb-0">Solicitar Aprovisionamiento</h5>
                    <span class="badge-soft">Dataverse</span>
                </div>
                <div class="small text-muted">Envía la solicitud a Power Automate para crear las líneas en cr07a_solicitudaprovisionamiento.</div>
            </div>
            <button type="button" class="btn btn-sm btn-outline-secondary" id="btnCloseProvisioning">×</button>
        </div>

        <div class="row g-3">
            <div class="col-md-4">
                <label class="form-label fw-bold">Fecha de aprovisionamiento</label>
                <input type="date" id="provisioningDate" class="form-control" />
            </div>

            <div class="col-md-4">
                <label class="form-label fw-bold">Tipo de contrato</label>
                <select id="provisioningContractType" class="form-select">
                    <option value="">Seleccione</option>
                    <option value="645250000">Nuevo</option>
                    <option value="645250001">Contrato existente</option>
                </select>
            </div>

            <div class="col-md-12">
                <label class="form-label fw-bold">Cliente</label>
                <div style="position:relative;">
                    <input type="text" id="provisioningClientInput" class="form-control" placeholder="Buscar cliente..." autocomplete="off" />
                    <div id="clientSuggestions" class="suggestions"></div>
                </div>
                <div class="small text-muted mt-1">Escribe para buscar en cr07a_cliente por cr07a_nombre y selecciona una opción.</div>
            </div>
        </div>

        <div id="provisioningStatus" class="status-msg mt-3" style="display:none;"></div>

        <div class="d-flex justify-content-end gap-2 mt-3">
            <button type="button" class="btn btn-outline-secondary" id="btnCancelProvisioning">Cancelar</button>
            <button type="button" class="btn btn-primary" id="btnConfirmProvisioning">Confirmar solicitud</button>
        </div>
    </div>
</div>

<script>
(function () {
    const isCorporate = @((isCorporate ? "true" : "false"));
        const currentSegment = "@seg";
    const currentUser = @Html.Raw(JsonSerializer.Serialize(currentUser, new JsonSerializerOptions { PropertyNamingPolicy = JsonNamingPolicy.CamelCase }));
    const storedScenarios = @Html.Raw(JsonSerializer.Serialize(storedScenarios, new JsonSerializerOptions { PropertyNamingPolicy = JsonNamingPolicy.CamelCase }));
    const FLOW_CREATE_REQUEST_URL = "https://defaultcab7ea424a214548952ffcde81f2bd.d6.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/8529a99cb04c43af984f792d0d9974d4/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=WhOJuw2RosHFv74emV7f9ve_Kwj0DqwlEVlQNtg3Qbw"; // TODO: Pegar URL del Flow 1 (Crear Solicitud + Aprobación Angie)
    // TODO: Pegar URL del Flow 2 (Marcar Aprovisionadas) [si aplica]

    const contractTypeLabels = {
        "645250000": "Nuevo",
        "645250001": "Contrato existente"
    };

    const sourceSystem = "pricing-calculator";
    const businessTypes = [
        { key: 0, name: "ModernWork" },
        { key: 1, name: "Azure" },
        { key: 2, name: "Acronis" },
        { key: 3, name: "Perpetuo" },
        { key: 4, name: "Copiers" },
        { key: 5, name: "Otro" }
    ];

    let scenarios = [];
    let activeScenarioId = null;
    const provisioningState = { date: "", contractType: "", client: null, loading: false };
    let provisioningSearchTimer = null;
    let provisioningClientResults = [];

    const scenarioBar = document.getElementById("scenarioBar");
    const scenarioName = document.getElementById("scenarioName");
    const typeChips = document.getElementById("typeChips");
    const linesBody = document.getElementById("linesBody");

    const btnNewScenario = document.getElementById("btnNewScenario");
    const btnDuplicateScenario = document.getElementById("btnDuplicateScenario");
    const btnDeleteScenario = document.getElementById("btnDeleteScenario");

    const dealType = document.getElementById("dealType");
    const requiresProration = document.getElementById("requiresProration");
    const startDate = document.getElementById("startDate");
    const endDate = document.getElementById("endDate");
    const prorationHint = document.getElementById("prorationHint");

    const btnCalculate = document.getElementById("btnCalculate");
    const btnExport = document.getElementById("btnExport");
    const btnProvisioning = document.getElementById("btnProvisioning");
    const btnCloseProvisioning = document.getElementById("btnCloseProvisioning");
    const btnCancelProvisioning = document.getElementById("btnCancelProvisioning");
    const btnConfirmProvisioning = document.getElementById("btnConfirmProvisioning");
    const provisioningModal = document.getElementById("provisioningModal");
   const attachmentModal = document.getElementById("attachmentModal");
     const debugCalcModal = document.getElementById("debugCalcModal");
    const debugCalcContent = document.getElementById("debugCalcContent");
    const btnCloseDebugCalc = document.getElementById("btnCloseDebugCalc");
    const btnCloseDebugCalcBottom = document.getElementById("btnCloseDebugCalcBottom");
    const provisioningDate = document.getElementById("provisioningDate");
    const provisioningContractType = document.getElementById("provisioningContractType");
    const provisioningClientInput = document.getElementById("provisioningClientInput");
    const clientSuggestions = document.getElementById("clientSuggestions");
    const provisioningStatus = document.getElementById("provisioningStatus");
    const provisioningLog = document.getElementById("provisioningLog");
    const attachmentInput = document.getElementById("attachmentInput");
    const attachmentStatus = document.getElementById("attachmentStatus");
    const attachmentLabel = document.getElementById("attachmentLabel");
    const attachmentFileName = document.getElementById("attachmentFileName");
    const btnCloseAttachment = document.getElementById("btnCloseAttachment");
    const btnCancelAttachment = document.getElementById("btnCancelAttachment");

    const resultPoints = document.getElementById("resultPoints");
    const resultCommission = document.getElementById("resultCommission");
    const resultSegment = document.getElementById("resultSegment");
    const resultProration = document.getElementById("resultProration");
    const resultMonthly = document.getElementById("resultMonthly");
    const resultTotal = document.getElementById("resultTotal");

    const attachmentState = { fileName: "", contentType: "", base64: "" };


    // const SMB_LICENSE_CAP = 300;
   //  const CORPORATE_MIN_LICENSES = 300;
    function uid() { return Math.random().toString(16).slice(2) + Date.now().toString(16); }

    function money(n) {
        const v = Number(n || 0);
        return v.toLocaleString("es-CO", { style: "currency", currency: "COP", maximumFractionDigits: 2 });
    }

    function num(n, digits = 2) {
        const v = Number(n || 0);
        return v.toLocaleString("es-CO", { maximumFractionDigits: digits, minimumFractionDigits: digits });
    }

    function clampInt(v, min, max, fallback) {
        const n = parseInt(v, 10);
        if (isNaN(n)) return fallback;
        return Math.max(min, Math.min(max, n));
    }

    function clampDec(v, fallback) {
        const n = parseFloat(String(v).replace(",", "."));
        if (isNaN(n)) return fallback;
        return n;
    }

    function escapeHtml(s) {
        return (s ?? "").replaceAll("&", "&amp;").replaceAll("<", "&lt;").replaceAll(">", "&gt;");
    }
function getDealTypeLabel(dealType) {
        switch (Number(dealType)) {
            case 0: return "ClienteNuevo";
            case 1: return "CrossSale";
            case 2: return "Renovación 1 vez";
            case 3: return "Renovación 2 veces";
            case 4: return "Renovación 3 veces o más";
            default: return "Sin definir";
        }
    }

    function getDealTypeMultiplier(dealType) {
        switch (Number(dealType)) {
            case 0: return 1.10;
            case 1: return 1.00;
            case 2: return 0.40;
            case 3: return 0.25;
            case 4: return 0.20;
            default: return 1.00;
        }
    }

    function getSegmentMultiplier(segment) {
        return segment === "Corporate" ? 1.15 : 1.00;
    }

const showDebugCalcModal = false;

    function openDebugCalcModal(html) {
        if (!showDebugCalcModal) return;
                if (!debugCalcModal || !debugCalcContent) return;
        debugCalcContent.innerHTML = html;
        debugCalcModal.style.display = "flex";
        debugCalcModal.setAttribute("aria-hidden", "false");
    }

    function closeDebugCalcModal() {
        if (!debugCalcModal) return;
        debugCalcModal.style.display = "none";
        debugCalcModal.setAttribute("aria-hidden", "true");
    }

    function buildDebugCalcHtml(payload, data) {
        const lines = payload.lines || [];
        let totalCost = 0;
        let totalSaleUnit = 0;
        let totalMonthly = 0;
        let totalSale = 0;
        let totalUtility = 0;
        let totalAcelerador = 0;

        const lineRows = lines.map((line, idx) => {
            const cost = Number(line.costUnit || 0);
            const margin = Number(line.marginPercent || 0);
            const qty = Number(line.quantity || 0);
            const months = Number(line.contractMonths || 0);
            const acelerador = Number(line.acelerador || 0);
            const saleUnit = cost * (1 + (margin / 100));
            const monthly = saleUnit * qty;
            const total = monthly * months;
            const utilidadLinea = ((saleUnit - cost) + (cost * acelerador)) * qty * months;

            totalCost += cost * qty;
            totalSaleUnit += saleUnit * qty;
            totalMonthly += monthly;
            totalSale += total;
            totalUtility += utilidadLinea;
            totalAcelerador += (cost * acelerador) * qty * months;

            return `
                <tr>
                    <td>#${idx + 1} ${escapeHtml(line.productDescription || "Producto")}</td>
                    <td>${num(cost)} × ${qty} × ${months}m</td>
                    <td>${num(margin)}%</td>
                    <td>${num(acelerador)}</td>
                    <td>${money(saleUnit)}</td>
                    <td>${money(total)}</td>
                    <td>${money(utilidadLinea)}</td>
                </tr>
            `;
        }).join("");

        const segment = data.segment || "—";
        const segmentMultiplier = getSegmentMultiplier(segment);
        const dealMultiplier = getDealTypeMultiplier(payload.dealType);
        const prorationFactor = Number(data.prorationFactor || 1);
        const prorationDays = Number(data.prorationDays || 0);

        const utilidadSegmento = totalUtility * segmentMultiplier;
        const utilidadNegocio = utilidadSegmento * dealMultiplier;
        const utilidadProrrateada = utilidadNegocio * prorationFactor;

        const puntosCalculados = (utilidadProrrateada / 750) * 100;
        const comisionUsd = puntosCalculados * 7.5;
        const comisionCop = comisionUsd * 4000;

        return `
            <div class="debug-grid mb-2">
                <div><span class="debug-chip">Segmento</span> ${escapeHtml(segment)}</div>
                <div><span class="debug-chip">Tipo negocio</span> ${escapeHtml(getDealTypeLabel(payload.dealType))}</div>
                <div><span class="debug-chip">Prorrateo</span> ${prorationDays ? `${prorationDays} días (${num(prorationFactor, 4)})` : "No"}</div>
                <div><span class="debug-chip">Líneas</span> ${lines.length}</div>
            </div>
            <table class="debug-table mb-2">
                <thead>
                    <tr>
                        <th>Producto</th>
                        <th>Costo × Qty × Meses</th>
                        <th>Margen</th>
                        <th>Acelerador</th>
                        <th>Venta UND</th>
                        <th>Venta Total</th>
                        <th>Utilidad línea</th>
                    </tr>
                </thead>
                <tbody>${lineRows || "<tr><td colspan=\"7\">Sin líneas.</td></tr>"}</tbody>
            </table>
            <table class="debug-table">
                <tbody>
                    <tr><th>Totales visibles</th><td>Venta mensual: ${money(totalMonthly)} | Venta total: ${money(totalSale)}</td></tr>
                    <tr><th>Costo total</th><td>${money(totalCost)} (suma de costo × qty)</td></tr>
                    <tr><th>Utilidad base</th><td>${money(totalUtility)} (incluye acelerador: ${money(totalAcelerador)})</td></tr>
                    <tr><th>+ Segmento</th><td>${num(segmentMultiplier, 2)} → ${money(utilidadSegmento)}</td></tr>
                    <tr><th>+ Tipo negocio</th><td>${num(dealMultiplier, 2)} → ${money(utilidadNegocio)}</td></tr>
                    <tr><th>+ Prorrateo</th><td>${num(prorationFactor, 4)} → ${money(utilidadProrrateada)}</td></tr>
                    <tr><th>Puntaje (calc / API)</th><td>${num(puntosCalculados, 2)} / ${num(data.points || 0, 2)}</td></tr>
                    <tr><th>Comisión COP (calc / API)</th><td>${money(comisionCop)} / ${money(data.commission || 0)}</td></tr>
                </tbody>
            </table>
        `;
    }

    function containsPrepaidOrYear(desc) {
        const t = (desc || "").toLowerCase();
        return t.includes("prepaid") || t.includes("1 year");
    }

    function getActiveScenario() { return scenarios.find(s => s.id === activeScenarioId); }

    function resetResults(clearStored = false) {
        if (clearStored) {
            const s = getActiveScenario();
            if (s) s.lastResult = null;
        }
        resultPoints.innerText = "—";
        resultCommission.innerText = "—";
        resultSegment.innerText = "—";
        resultProration.innerText = "—";
        resultMonthly.innerText = "—";
        resultTotal.innerText = "—";
    }

    function renderResultsFromScenario() {
        const s = getActiveScenario();
        if (s?.lastResult) {
            resultPoints.innerText = num(s.lastResult.points, 2);
            resultCommission.innerText = money(s.lastResult.commission);
            resultSegment.innerText = s.lastResult.segment || "—";
            resultProration.innerText = s.lastResult.prorationText || "—";
            resultMonthly.innerText = money(s.lastResult.totalMonthlySale || 0);
            resultTotal.innerText = money(s.lastResult.totalSale || 0);
            return;
        }
        resetResults(false);
    }

    function markScenarioDirty() {
        resetResults(true);
    }

    function calcLineComputed(line) {
        const cost = Number(line.costUnit || 0);
        const margin = Number(line.marginPercent || 0);
        const months = Number(line.contractMonths || 0);
        const qty = Number(line.quantity || 0);

        const saleUnit = cost * (1 + (margin / 100));
        const monthly = saleUnit * qty;
        const total = monthly * months;

        // ✅ REGLA CORRECTA:
        // Corporate discount SOLO aplica para líneas ModernWork (businessType === 0).
        // Para otras líneas, estas columnas no aplican (0).
        let discUnit = 0, discMonth = 0, discYear = 0, ahorro = 0;

        if (isCorporate && Number(line.businessType) === 0) {
            discUnit = saleUnit * 0.9;     // -10% sobre Venta UND
            discMonth = discUnit * qty;
            discYear = discMonth * months;
            ahorro = (saleUnit * qty * months) - discYear;
        }

        return { saleUnit, monthly, total, discUnit, discMonth, discYear, ahorro };
    
    }

    function calcTotals(lines) {
        let tCost = 0, tSaleUnit = 0, tMonthly = 0, tTotal = 0, tSuggested = 0;
        let tDiscUnit = 0, tDiscMonth = 0, tDiscYear = 0, tAhorro = 0;

        for (const line of lines) {
            const c = calcLineComputed(line);

            tCost += Number(line.costUnit || 0) * Number(line.quantity || 0);
            tSaleUnit += c.saleUnit * Number(line.quantity || 0);

            tMonthly += c.monthly;
            tTotal += c.total;

            tSuggested += Number(line.suggestedRetailPrice || 0) * Number(line.quantity || 0);

            tDiscUnit += c.discUnit * Number(line.quantity || 0);
            tDiscMonth += c.discMonth;
            tDiscYear += c.discYear;
            tAhorro += c.ahorro;
        }

        return { tCost, tSaleUnit, tMonthly, tTotal, tSuggested, tDiscUnit, tDiscMonth, tDiscYear, tAhorro };
    }

    function renderTypeChips() {
        typeChips.innerHTML = businessTypes.map(t => `<div class="type-chip" data-type="${t.key}">${t.name}</div>`).join("");
        typeChips.querySelectorAll(".type-chip").forEach(chip => {
            chip.addEventListener("click", () => {
                const typeKey = Number(chip.getAttribute("data-type"));
                addLine(typeKey);
                typeChips.querySelectorAll(".type-chip").forEach(x => x.classList.remove("active"));
                chip.classList.add("active");
                setTimeout(() => chip.classList.remove("active"), 600);
            });
        });
    }

    function renderScenarioBar() {
        scenarioBar.innerHTML = scenarios.map(s => {
            const active = s.id === activeScenarioId ? "active" : "";
            const lineCount = s.lines.length;
            return `
                <div class="scenario-tab ${active}" data-sid="${s.id}">
                    <div>
                        <p class="scenario-name">${escapeHtml(s.name)}</p>
                        <p class="scenario-sub">${lineCount} líneas</p>
                    </div>
                    <div class="pill">Abrir</div>
                </div>
            `;
        }).join("");

        scenarioBar.querySelectorAll(".scenario-tab").forEach(tab => {
            tab.addEventListener("click", () => {
                activeScenarioId = tab.getAttribute("data-sid");
                syncScenarioPanel();
            });
        });
    }

    function renderLines() {
        const s = getActiveScenario();
        if (!s) return;

        if (!s.lines.length) {
            linesBody.innerHTML = `
                <tr>
                    <td colspan="${isCorporate ? 15 : 11}" class="muted">
                        No hay líneas. Agrega una línea seleccionando un <strong>Tipo de negocio</strong>.
                    </td>
                </tr>
            `;
            return;
        }

        const rows = s.lines.map((line, idx) => {
            const computed = calcLineComputed(line);
            const lockCost = Number(line.businessType) === 0;
            const lockMonths = containsPrepaidOrYear(line.productDescription);

            const costDisabled = lockCost ? "disabled" : "";
            const monthsDisabled = lockMonths ? "disabled" : "";

            const corpCols = isCorporate ? `
                <td class="corp-bg">${num(computed.discUnit, 2)}</td>
                <td class="corp-bg">${num(computed.discMonth, 2)}</td>
                <td class="corp-bg">${num(computed.discYear, 2)}</td>
                <td class="corp-bg">${num(computed.ahorro, 2)}</td>
            ` : "";

            return `
                <tr data-idx="${idx}">
                    <td><span class="pill">${escapeHtml(businessTypes.find(x => x.key === Number(line.businessType))?.name || "—")}</span></td>

                    <td>
                        <div style="position:relative;">
                            <input class="form-control form-control-sm product-input" value="${escapeHtml(line.productDescription)}" placeholder="Buscar producto..." autocomplete="off" />
                            <div class="suggestions"></div>
                        </div>
                        <div class="small muted mt-1">${lockMonths ? 'Duración fija 12 meses (Prepaid/1 Year)' : ''}</div>
                    </td>

                    <td>
                        <input class="form-control form-control-sm cost-input" value="${num(line.costUnit,2)}" ${costDisabled} />
                        <div class="small muted mt-1">${lockCost ? 'ModernWork: no editable' : ''}</div>
                    </td>

                    <td><input class="form-control form-control-sm margin-input" value="${num(line.marginPercent,2)}" /></td>
                    <td><input class="form-control form-control-sm months-input" value="${line.contractMonths}" ${monthsDisabled} /></td>
                    <td>${num(computed.saleUnit,2)}</td>
                    <td><input class="form-control form-control-sm qty-input" value="${line.quantity}" /></td>
                    <td>${num(computed.monthly,2)}</td>
                    <td>${num(computed.total,2)}</td>

                    ${corpCols}

                    <td>${num(line.suggestedRetailPrice,2)}</td>

                    <td class="text-end">
                        <button class="btn btn-sm btn-outline-danger btn-del-line" type="button">×</button>
                    </td>
                </tr>
            `;
        }).join("");

        const totals = calcTotals(s.lines);
        const corpTotals = isCorporate ? `
            <td class="corp-bg">${num(totals.tDiscUnit,2)}</td>
            <td class="corp-bg">${num(totals.tDiscMonth,2)}</td>
            <td class="corp-bg">${num(totals.tDiscYear,2)}</td>
            <td class="corp-bg">${num(totals.tAhorro,2)}</td>
        ` : "";

        const totalsRow = `
            <tr class="totals-row">
                <td colspan="2">Totales</td>
                <td>${num(totals.tCost,2)}</td>
                <td>—</td>
                <td>—</td>
                <td>${num(totals.tSaleUnit,2)}</td>
                <td>—</td>
                <td>${num(totals.tMonthly,2)}</td>
                <td>${num(totals.tTotal,2)}</td>
                ${corpTotals}
                <td>${num(totals.tSuggested,2)}</td>
                <td></td>
            </tr>
        `;

        linesBody.innerHTML = rows + totalsRow;
        wireLineEvents();
    }

    function createScenario(name) {
        const id = uid();
 return { id, name: name || "Escenario", dealType: 0, requiresProration: false, startDate: "", endDate: "", lines: [], lastResult: null };    }
 function toDateInputValue(value) {
        if (!value) return "";
        const str = String(value);
        if (str.length >= 10) return str.substring(0, 10);
        return str;
    }

    function mapStoredScenario(stored) {
        return {
            id: stored.scenarioId || uid(),
            name: stored.scenarioName || "Escenario",
            dealType: Number(stored.dealType || 0),
            requiresProration: Boolean(stored.requiresProration),
            startDate: toDateInputValue(stored.startDate),
            endDate: toDateInputValue(stored.endDate),
            lines: Array.isArray(stored.lines) ? stored.lines.map(line => ({
                businessType: Number(line.businessType || 0),
                productId: line.productId || "",
                productDescription: line.productDescription || "",
                costUnit: Number(line.costUnit || 0),
                marginPercent: Number(line.marginPercent || 0),
                contractMonths: Number(line.contractMonths || 12),
                quantity: Number(line.quantity || 1),
                suggestedRetailPrice: Number(line.suggestedRetailPrice || 0),
                acelerador: Number(line.acelerador || 0)
            })) : [],
            lastResult: stored.lastResult || null
        };
    }

    function syncScenarioPanel() {
        const s = getActiveScenario();
        if (!s) return;

        scenarioName.value = s.name;
        dealType.value = String(s.dealType);
        requiresProration.value = String(s.requiresProration);
        startDate.value = s.startDate || "";
        endDate.value = s.endDate || "";

        startDate.disabled = !s.requiresProration;
        endDate.disabled = !s.requiresProration;

        renderScenarioBar();
        renderLines();
        renderResultsFromScenario();
                updateProrationHint();
    }

    function addScenario() {
        const s = createScenario(`Escenario ${scenarios.length + 1}`);
        scenarios.push(s);
        activeScenarioId = s.id;
        syncScenarioPanel();
    }

    function duplicateScenario() {
        const current = getActiveScenario();
        if (!current) return;

        const copy = JSON.parse(JSON.stringify(current));
        copy.id = uid();
        copy.name = `${current.name} (copia)`;
        scenarios.push(copy);
        activeScenarioId = copy.id;
        syncScenarioPanel();
    }

    function deleteScenario() {
        if (scenarios.length <= 1) { alert("Debes mantener al menos 1 escenario."); return; }
        scenarios = scenarios.filter(s => s.id !== activeScenarioId);
        activeScenarioId = scenarios[0].id;
        syncScenarioPanel();
    }

    function addLine(businessTypeKey) {
        const s = getActiveScenario();
        if (!s) return;

        s.lines.push({
            businessType: businessTypeKey,
            productId: "",
            productDescription: "",
            costUnit: 0,
            marginPercent: 0,
            contractMonths: 12,
            quantity: 1,
            suggestedRetailPrice: 0,
            acelerador: 0
        });

        markScenarioDirty();
        renderLines();
        setTimeout(() => {
            const last = linesBody.querySelector(`tr[data-idx="${s.lines.length - 1}"] .product-input`);
            if (last) last.focus();
        }, 0);
    }

    function removeLine(index) {
        const s = getActiveScenario();
        if (!s) return;
        s.lines.splice(index, 1);
                markScenarioDirty();
        renderLines();
    }

    async function productSearch(q) {
        const res = await fetch(`/Calculator/ProductSearch?q=${encodeURIComponent(q)}`, { headers: { "Accept": "application/json" } });
        if (!res.ok) return [];
        return await res.json();
    }

     async function clientSearch(q) {
        const res = await fetch(`/Calculator/ClientSearch?q=${encodeURIComponent(q)}`, { headers: { "Accept": "application/json" } });
        if (!res.ok) return [];
        return await res.json();
    }


    function positionFullWidthSuggestions(suggBox, inputEl) {
        const rect = inputEl.getBoundingClientRect();
        const top = Math.round(rect.bottom + 6);
        const maxH = Math.max(180, window.innerHeight - top - 16);

        suggBox.style.top = `${top}px`;
        suggBox.style.maxHeight = `${maxH}px`;
    }

    function wireLineEvents() {
        const s = getActiveScenario();
        if (!s) return;

        linesBody.querySelectorAll("tr[data-idx]").forEach(row => {
            const idx = Number(row.getAttribute("data-idx"));
            const line = s.lines[idx];

            const productInput = row.querySelector(".product-input");
            const suggBox = row.querySelector(".suggestions");

            const costInput = row.querySelector(".cost-input");
            const marginInput = row.querySelector(".margin-input");
            const monthsInput = row.querySelector(".months-input");
            const qtyInput = row.querySelector(".qty-input");

            const btnDel = row.querySelector(".btn-del-line");
            btnDel.addEventListener("click", () => removeLine(idx));

            function refreshLineFromInputs() {
                line.costUnit = clampDec(costInput.value, 0);
                line.marginPercent = clampDec(marginInput.value, 0);
                line.contractMonths = clampInt(monthsInput.value, 1, 120, 12);
                line.quantity = clampInt(qtyInput.value, 1, 999999, 1);

                if (containsPrepaidOrYear(line.productDescription)) {
                    line.contractMonths = 12;
                }
                                markScenarioDirty();
                renderLines();
            }

            costInput.addEventListener("change", refreshLineFromInputs);
            marginInput.addEventListener("change", refreshLineFromInputs);
            monthsInput.addEventListener("change", refreshLineFromInputs);
            qtyInput.addEventListener("change", refreshLineFromInputs);

            let timer = null;
            let lastItems = [];

            function hideSuggestions() {
                suggBox.style.display = "none";
                suggBox.innerHTML = "";
            }

            productInput.addEventListener("focus", () => {
                if (suggBox.style.display === "block") {
                    positionFullWidthSuggestions(suggBox, productInput);
                }
            });

            productInput.addEventListener("input", () => {
                const q = productInput.value.trim();
                line.productDescription = q;
                markScenarioDirty();

                clearTimeout(timer);
                if (q.length < 2) {
                    hideSuggestions();
                    return;
                }

                timer = setTimeout(async () => {
                    lastItems = await productSearch(q);
                    if (!lastItems.length) {
                        hideSuggestions();
                        return;
                    }

                    positionFullWidthSuggestions(suggBox, productInput);

                    suggBox.innerHTML = lastItems.map((x, j) => `
                        <div class="suggestion-item" data-j="${j}">
                            <div style="font-weight:800;">${escapeHtml(x.description)}</div>
                            <div class="small muted">Purchase: ${x.purchasePrice ?? "—"} | Suggested: ${x.suggestedRetailPrice ?? "—"}</div>
                        </div>
                    `).join("");

                    suggBox.style.display = "block";
                }, 220);
            });

            const onScrollResize = () => {
                if (suggBox.style.display === "block") {
                    positionFullWidthSuggestions(suggBox, productInput);
                }
            };
            window.addEventListener("scroll", onScrollResize, true);
            window.addEventListener("resize", onScrollResize);

            suggBox.addEventListener("click", (e) => {
                const itemDiv = e.target.closest(".suggestion-item");
                if (!itemDiv) return;

                const j = Number(itemDiv.getAttribute("data-j"));
                const item = lastItems[j];
                if (!item) return;

                line.productId = item.id || "";
                line.productDescription = item.description || "";
                line.suggestedRetailPrice = Number(item.suggestedRetailPrice || 0);
                line.acelerador = Number(item.acelerador || 0);

                if (Number(line.businessType) === 0) {
                    line.costUnit = Number(item.purchasePrice || 0);
                } else {
                    line.costUnit = line.costUnit || 0;
                }

                if (containsPrepaidOrYear(line.productDescription)) {
                    line.contractMonths = 12;
                }
                markScenarioDirty();
                hideSuggestions();
            
                renderLines();
            });

            document.addEventListener("click", (e) => {
                if (e.target === productInput || suggBox.contains(e.target)) return;
                hideSuggestions();
            });
        });
    }

    function updateProrationHint() {
        const s = getActiveScenario();
        if (!s) return;

        if (!s.requiresProration) {
            prorationHint.style.display = "none";
            prorationHint.innerText = "";
            return;
        }

        if (!s.startDate || !s.endDate) {
            prorationHint.style.display = "block";
            prorationHint.innerText = "Selecciona fecha inicio y fecha final para calcular días de prorrateo.";
            return;
        }

        const sd = new Date(s.startDate);
        const ed = new Date(s.endDate);
        if (isNaN(sd.getTime()) || isNaN(ed.getTime()) || ed < sd) {
            prorationHint.style.display = "block";
            prorationHint.innerText = "Fechas inválidas. La fecha final debe ser >= fecha inicio.";
            return;
        }

        const ms = ed.getTime() - sd.getTime();
        const days = Math.floor(ms / (1000 * 60 * 60 * 24)) + 1;
        const factor = days / 365.0;

        prorationHint.style.display = "block";
        prorationHint.innerText = `Prorrateo: ${days} días. Factor aproximado: ${factor.toFixed(4)} (sobre 365).`;
    }

    function validateScenarioLines() {
        const s = getActiveScenario();
        if (!s) {
            alert("Selecciona un escenario activo.");
            return null;
        }

        if (!s.lines.length) { alert("Agrega al menos 1 línea."); return null; }

        const normalizedLines = [];
        for (const [i, line] of s.lines.entries()) {
            const productDescription = (line.productDescription || "").trim();
            if (!productDescription || productDescription.length < 2) {
                alert(`La línea ${i + 1} no tiene producto.`);
                return null;
            }
            const qty = Number(line.quantity || 0);
            if (qty <= 0) { alert(`La línea ${i + 1} tiene cantidad inválida.`); return null; }
            const months = Number(line.contractMonths || 0);
            if (months <= 0) { alert(`La línea ${i + 1} tiene duración inválida.`); return null; }

            normalizedLines.push({
                businessType: Number(line.businessType),
                productId: line.productId || "",
                productDescription,
                costUnit: Number(line.costUnit || 0),
                marginPercent: Number(line.marginPercent || 0),
                contractMonths: Number(months || 12),
                quantity: Number(qty || 1),
                suggestedRetailPrice: Number(line.suggestedRetailPrice || 0),
                acelerador: Number(line.acelerador || 0)
            });
        }
   const licenseValidation = validateLicenseCaps(s, normalizedLines);
        if (licenseValidation) {
            alert(licenseValidation);
            return null;
        }

        return { scenario: s, lines: normalizedLines };
    }

      function validateLicenseCaps(scenario, lines) {
        if (Number(scenario?.dealType) === 1) {
            return "";
        }
  if (currentSegment === "Super") {
            return "";
        }

         // Restricciones de cantidad de licencias SMB/Corporate deshabilitadas por solicitud.
        // const restrictedTotal = lines.reduce((total, line) => {
        //     const desc = (line.productDescription || "").toLowerCase();
        //     if (desc.includes("business") || desc.includes("microsoft 365")) {
        //         return total + Number(line.quantity || 0);
        //     }
        //     return total;
        // }, 0);
        //
        // if (currentSegment === "SMB" && restrictedTotal >= SMB_LICENSE_CAP) {
        //     return `Para usuarios SMB, la suma de licencias con productos que contengan "business" o "Microsoft 365" no puede ser igual o mayor a ${SMB_LICENSE_CAP}. Total actual: ${restrictedTotal}.`;
        // }
        //
        // if (currentSegment === "Corporate" && restrictedTotal > 0 && restrictedTotal < CORPORATE_MIN_LICENSES) {
        //     return `Para usuarios Corporate, la suma de licencias con productos que contengan "business" o "Microsoft 365" debe ser igual o mayor a ${CORPORATE_MIN_LICENSES}. Total actual: ${restrictedTotal}.`;
        // }
        return "";
    }


    function buildPayload() {
        const validated = validateScenarioLines();
        if (!validated) return null;

        const { scenario: s, lines } = validated;

        return {
            scenarioName: s.name,
            dealType: Number(s.dealType),
            requiresProration: Boolean(s.requiresProration),
            startDate: s.startDate ? new Date(s.startDate).toISOString() : null,
            endDate: s.endDate ? new Date(s.endDate).toISOString() : null,
            lines
        };
    }
async function saveScenarioToDataverse(scenario, lines) {
        if (!scenario) return;
        if (!Array.isArray(lines) || lines.length === 0) return;

        const payload = {
            scenarioId: scenario.id,
            scenarioName: scenario.name,
            dealType: Number(scenario.dealType || 0),
            requiresProration: Boolean(scenario.requiresProration),
            startDate: scenario.startDate ? new Date(scenario.startDate).toISOString() : null,
            endDate: scenario.endDate ? new Date(scenario.endDate).toISOString() : null,
            lines,
            lastResult: scenario.lastResult || null
        };

        const res = await fetch("/Calculator/SaveScenario", {
            method: "POST",
            headers: { "Content-Type": "application/json", "Accept": "application/json" },
            body: JSON.stringify(payload)
        });

        if (!res.ok) {
            const txt = await res.text();
            throw new Error(txt || "Error guardando escenario.");
        }
    }

    async function calculate() {
        const payload = buildPayload();
        if (!payload) return;

        btnCalculate.disabled = true;
        btnCalculate.innerText = "Calculando...";

        try {
            const res = await fetch("/Calculator/Calculate", {
                method: "POST",
                headers: { "Content-Type": "application/json", "Accept": "application/json" },
                body: JSON.stringify(payload)
            });

            if (!res.ok) {
                const txt = await res.text();
                throw new Error(txt || "Error calculando.");
            }

            const data = await res.json();

            const s = getActiveScenario();
            if (s) {
                s.lastResult = {
                    points: Number(data.points || 0),
                    commission: Number(data.commission || 0),
                    segment: data.segment || "—",
                    prorationText: (data.prorationFactor && data.prorationFactor !== 1)
                        ? `${data.prorationDays} días (${Number(data.prorationFactor).toFixed(4)})`
                        : "No",
                    totalMonthlySale: Number(data.totalMonthlySale || 0),
                    totalSale: Number(data.totalSale || 0)
                };
            }

            renderResultsFromScenario();
             if (s) {
                await saveScenarioToDataverse(s, payload.lines);
            }
            const debugHtml = buildDebugCalcHtml(payload, data);
            openDebugCalcModal(debugHtml);
        } catch (err) {
            alert("Error: " + (err?.message || err));
        } finally {
            btnCalculate.disabled = false;
            btnCalculate.innerText = "Calcular";
        }
    }

    async function exportExcel() {
        const payload = buildPayload();
        if (!payload) return;

        btnExport.disabled = true;
        btnExport.innerText = "Exportando...";

        try {
            const res = await fetch("/Calculator/Export", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });

            if (!res.ok) {
                const txt = await res.text();
                throw new Error(txt || "Error exportando.");
            }

            const blob = await res.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement("a");
            const safeName = (payload.scenarioName || "cotizacion").trim().replace(/[^a-zA-Z0-9-_ ]/g, "") || "cotizacion";
            a.href = url;
            a.download = `${safeName.replace(/\s+/g, "_")}.xlsx`;
            document.body.appendChild(a);
            a.click();
            a.remove();
            window.URL.revokeObjectURL(url);
        } catch (err) {
            alert("Error: " + (err?.message || err));
        } finally {
            btnExport.disabled = false;
            btnExport.innerText = "Exportar Excel";
        }
    }

    function setProvisioningStatus(message, type = "error") {
        provisioningStatus.classList.remove("status-success", "status-error");
        if (!message) {
            provisioningStatus.style.display = "none";
            provisioningStatus.innerText = "";
            return;
        }
        provisioningStatus.classList.add(type === "success" ? "status-success" : "status-error");
        provisioningStatus.innerText = message;
        provisioningStatus.style.display = "block";
    }

    function appendProvisioningLog(message, isError = false) {
        if (!message) return;
        const ts = new Date().toLocaleString();
        const line = `<div class="${isError ? "text-danger" : "text-success"}">${escapeHtml(ts)} - ${escapeHtml(message)}</div>`;
        provisioningLog.innerHTML = line + (provisioningLog.innerHTML || "");
    }
function setAttachmentStatus(message, type = "error") {
        if (!attachmentStatus) return;
        attachmentStatus.classList.remove("status-success", "status-error");
        if (!message) {
            attachmentStatus.style.display = "none";
            attachmentStatus.innerText = "";
            return;
        }
        attachmentStatus.classList.add(type === "success" ? "status-success" : "status-error");
        attachmentStatus.innerText = message;
        attachmentStatus.style.display = "block";
    }

    function resetProvisioningForm() {
        provisioningState.date = "";
        provisioningState.contractType = "";
        provisioningState.client = null;
        provisioningState.loading = false;
        provisioningDate.value = "";
        provisioningContractType.value = "";
        provisioningClientInput.value = "";
        attachmentState.fileName = "";
        attachmentState.contentType = "";
        attachmentState.base64 = "";
        if (attachmentInput) {
            attachmentInput.value = "";
        }
        if (attachmentFileName) {
            attachmentFileName.innerText = "";
        }
        updateAttachmentLabel();
        btnConfirmProvisioning.disabled = false;
        btnConfirmProvisioning.innerText = "Confirmar solicitud";
        setProvisioningStatus("");
        setAttachmentStatus("");
        hideClientSuggestions();
    }

    function openProvisioningModal() {
        resetProvisioningForm();
        provisioningModal.style.display = "flex";
        provisioningModal.setAttribute("aria-hidden", "false");
        provisioningDate.focus();
    }

    function closeProvisioningModal() {
        provisioningModal.style.display = "none";
        provisioningModal.setAttribute("aria-hidden", "true");
        provisioningState.loading = false;
        btnConfirmProvisioning.disabled = false;
        btnConfirmProvisioning.innerText = "Confirmar solicitud";
          closeAttachmentModal();
        hideClientSuggestions();
    }

    function openAttachmentModal() {
        if (!attachmentModal) return;
        attachmentModal.style.display = "flex";
        attachmentModal.setAttribute("aria-hidden", "false");
        if (attachmentInput) {
            attachmentInput.focus();
        }
    }

    function closeAttachmentModal() {
        if (!attachmentModal) return;
        attachmentModal.style.display = "none";
        attachmentModal.setAttribute("aria-hidden", "true");
    }

    function hideClientSuggestions() {
        clientSuggestions.style.display = "none";
        clientSuggestions.innerHTML = "";
    }
    function normalizeProvisioningDate(dateStr) {
        if (!dateStr) return "";
        const parsed = new Date(`${dateStr}T00:00:00Z`);
        if (isNaN(parsed.getTime())) return "";
        return parsed.toISOString();
    }

    function updateAttachmentLabel() {
        if (!attachmentLabel) return;
        const baseLabel = "Adjuntar oferta autorizada o correo de aprobación";
        if (!provisioningState.contractType) {
            attachmentLabel.innerText = baseLabel;
            return;
        }
        const contractLabel = contractTypeLabels[provisioningState.contractType] || "Tipo desconocido";
        attachmentLabel.innerText = `${baseLabel} (${contractLabel})`;
    }

    function validateAttachmentState() {
        if (!attachmentState.base64 || !attachmentState.fileName) {
            return "Debes adjuntar la oferta autorizada o correo de aprobación.";
        }
        const ext = attachmentState.fileName.split(".").pop()?.toLowerCase() || "";
        const allowedExt = ["pdf", "jpg", "jpeg", "doc", "docx"];
        if (!allowedExt.includes(ext)) {
            return "El adjunto debe ser PDF, JPG/JPEG o DOC/DOCX.";
        }
        return "";
    }

    function setAttachmentState(file, base64) {
        attachmentState.fileName = file.name || "";
        attachmentState.contentType = file.type || "";
        attachmentState.base64 = base64 || "";
        if (attachmentFileName) {
            attachmentFileName.innerText = attachmentState.fileName ? `Archivo cargado: ${attachmentState.fileName}` : "";
        }
    }


    function buildProvisioningPayload() {
        const validated = validateScenarioLines();
        if (!validated) return null;

        const { scenario: s, lines } = validated;

        if (!provisioningState.date) {
            setProvisioningStatus("Selecciona una fecha de aprovisionamiento.");
            return null;
        }
        if (!provisioningState.contractType) {
            setProvisioningStatus("Selecciona un tipo de contrato.");
            return null;
        }
        if (!provisioningState.client?.id) {
            setProvisioningStatus("Debes seleccionar un cliente de la lista.");
            return null;
        }
        if (!s.lastResult) {
            setProvisioningStatus("Calcula el escenario para tomar puntaje y comisión antes de solicitar.");
            return null;
        }
const attachmentError = validateAttachmentState();
        if (attachmentError) {
            setProvisioningStatus(attachmentError);
            openAttachmentModal();
            return null;
        }

        const selectedContract = provisioningContractType.selectedOptions?.[0];
         const normalizedDate = normalizeProvisioningDate(provisioningState.date);

        if (!normalizedDate) {
            setProvisioningStatus("Fecha de aprovisionamiento inválida.");
            return null;
        }
        const contractLabel = (selectedContract?.textContent || contractTypeLabels[provisioningState.contractType] || "Nuevo").trim();
        const lineItems = lines.map((line, idx) => ({
            lineId: line.productId || `line-${idx + 1}`,
            productoId: line.productId || "",
            productoNombre: line.productDescription,
            cantidad: Number(line.quantity || 0),
            number: Number(line.costUnit || 0)
        })).filter(li => li.cantidad > 0);

        if (!lineItems.length) {
            setProvisioningStatus("Necesitas al menos una línea con cantidad válida.");
            return null;
        }

        return {
            source: sourceSystem,
            businessId: s.id || s.name || uid(),
            requester: {
                systemUserId: currentUser?.systemUserId || "",
                displayName: currentUser?.displayName || "",
                email: currentUser?.email || ""
            },
            cliente: {
                clienteId: provisioningState.client.id,
                nombre: provisioningState.client.name
            },
            aprovisionamiento: {
                 fecha: normalizedDate,
                tipoContratoCode: String(provisioningState.contractType || ""),
                tipoContratoLabel: contractLabel
            },
            resultado: {
                puntaje: Number(s.lastResult?.points || 0),
                comision: Number(s.lastResult?.commission || 0)
            },
            lineItems,
            attachment: {
                fileName: attachmentState.fileName,
                contentType: attachmentState.contentType,
                base64: attachmentState.base64
            }
        };
    }

    async function submitProvisioningRequest() {
        if (provisioningState.loading) return;
        setProvisioningStatus("");
        const payload = buildProvisioningPayload();
        if (!payload) return;

        const validationRes = await fetch("/Calculator/ValidateProvisioning", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        });
        if (!validationRes.ok) {
            const txt = await validationRes.text();
            setProvisioningStatus(txt || "Error validando adjunto.");
            return;
        }


        if (!FLOW_CREATE_REQUEST_URL || FLOW_CREATE_REQUEST_URL.includes("TODO")) {
            setProvisioningStatus("Configura la URL del Flow 1 antes de enviar (ver comentario TODO).");
            return;
        }

        provisioningState.loading = true;
        btnConfirmProvisioning.disabled = true;
        btnConfirmProvisioning.innerText = "Enviando...";

        try {
            const res = await fetch(FLOW_CREATE_REQUEST_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });

            if (!res.ok) {
                const txt = await res.text();
                throw new Error(txt || `Error HTTP ${res.status}`);
            }

            appendProvisioningLog(`Solicitud enviada (${payload.lineItems.length} líneas). Cliente: ${payload.cliente.nombre}.`);
            setProvisioningStatus("Solicitud enviada y enviada a aprobación.", "success");
            setTimeout(closeProvisioningModal, 600);
        } catch (err) {
            const message = err?.message || "Error enviando la solicitud.";
            setProvisioningStatus(message);
            appendProvisioningLog(message, true);
        } finally {
            provisioningState.loading = false;
            btnConfirmProvisioning.disabled = false;
            btnConfirmProvisioning.innerText = "Confirmar solicitud";
        }
    }

    scenarioName.addEventListener("change", () => {
        const s = getActiveScenario();
        if (!s) return;
        s.name = scenarioName.value.trim() || s.name;
        renderScenarioBar();
    });

    btnNewScenario.addEventListener("click", addScenario);
    btnDuplicateScenario.addEventListener("click", duplicateScenario);
    btnDeleteScenario.addEventListener("click", deleteScenario);

    dealType.addEventListener("change", () => {
        const s = getActiveScenario();
        if (!s) return;
        s.dealType = Number(dealType.value);
        markScenarioDirty();
    });

    requiresProration.addEventListener("change", () => {
        const s = getActiveScenario();
        if (!s) return;
        s.requiresProration = (requiresProration.value === "true");
        startDate.disabled = !s.requiresProration;
        endDate.disabled = !s.requiresProration;
        if (!s.requiresProration) {
            s.startDate = "";
            s.endDate = "";
            startDate.value = "";
            endDate.value = "";
        }
        updateProrationHint();
        markScenarioDirty();
    });

    startDate.addEventListener("change", () => {
        const s = getActiveScenario();
        if (!s) return;
        s.startDate = startDate.value;
        updateProrationHint();
        markScenarioDirty();
    });

    endDate.addEventListener("change", () => {
        const s = getActiveScenario();
        if (!s) return;
        s.endDate = endDate.value;
        updateProrationHint();
        markScenarioDirty();
    });

    provisioningDate.addEventListener("change", () => {
        provisioningState.date = provisioningDate.value;
    });

    provisioningContractType.addEventListener("change", () => {
        provisioningState.contractType = provisioningContractType.value;
        // Si cambia el tipo de contrato, mantenemos el adjunto y solo actualizamos el label.
        updateAttachmentLabel();
        if (provisioningState.contractType) {
            openAttachmentModal();
        }
    });

    provisioningClientInput.addEventListener("focus", () => {
        if (clientSuggestions.style.display === "block") {
            positionFullWidthSuggestions(clientSuggestions, provisioningClientInput);
        }
    });

    provisioningClientInput.addEventListener("input", () => {
        provisioningState.client = null;
        const q = provisioningClientInput.value.trim();

        clearTimeout(provisioningSearchTimer);
        if (q.length < 2) {
            hideClientSuggestions();
            return;
        }

        provisioningSearchTimer = setTimeout(async () => {
            provisioningClientResults = await clientSearch(q);
            if (!provisioningClientResults.length) {
                hideClientSuggestions();
                return;
            }

            positionFullWidthSuggestions(clientSuggestions, provisioningClientInput);
            clientSuggestions.innerHTML = provisioningClientResults.map((c, idx) => `
                <div class="suggestion-item" data-client-idx="${idx}">
                    <div style="font-weight:800;">${escapeHtml(c.name)}</div>
                    <div class="small muted">${escapeHtml(c.id)}</div>
                </div>
            `).join("");
            clientSuggestions.style.display = "block";
        }, 220);
    });

    clientSuggestions.addEventListener("click", (e) => {
        const itemDiv = e.target.closest(".suggestion-item");
        if (!itemDiv) return;
        const idx = Number(itemDiv.getAttribute("data-client-idx"));
        const item = provisioningClientResults[idx];
        if (!item) return;

        provisioningState.client = { id: item.id, name: item.name };
        provisioningClientInput.value = item.name;
        hideClientSuggestions();
    });

    const onClientScrollResize = () => {
        if (clientSuggestions.style.display === "block") {
            positionFullWidthSuggestions(clientSuggestions, provisioningClientInput);
        }
    };
    window.addEventListener("scroll", onClientScrollResize, true);
    window.addEventListener("resize", onClientScrollResize);
    document.addEventListener("click", (e) => {
        if (e.target === provisioningClientInput || clientSuggestions.contains(e.target)) return;
        hideClientSuggestions();
    });
if (attachmentInput) {
        attachmentInput.addEventListener("change", async () => {
            setAttachmentStatus("");
            const file = attachmentInput.files?.[0];
            if (!file) {
                setAttachmentState({ name: "", type: "" }, "");
                return;
            }
            const ext = file.name.split(".").pop()?.toLowerCase() || "";
            const allowedExt = ["pdf", "jpg", "jpeg", "doc", "docx"];
            if (!allowedExt.includes(ext)) {
                setAttachmentStatus("El archivo debe ser PDF, JPG/JPEG o DOC/DOCX.");
                attachmentInput.value = "";
                setAttachmentState({ name: "", type: "" }, "");
                return;
            }
            const base64 = await new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const result = String(reader.result || "");
                    resolve(result.split(",")[1] || "");
                };
                reader.onerror = () => reject(new Error("No se pudo leer el archivo."));
                reader.readAsDataURL(file);
            }).catch(err => {
                setAttachmentStatus(err?.message || "No se pudo leer el archivo.");
                return "";
            });
            if (!base64) {
                setAttachmentState({ name: "", type: "" }, "");
                return;
            }
            setAttachmentState(file, base64);
            setAttachmentStatus("Adjunto cargado correctamente.", "success");
        });
    }

    if (btnCloseAttachment) {
        btnCloseAttachment.addEventListener("click", closeAttachmentModal);
    }
    if (btnCancelAttachment) {
        btnCancelAttachment.addEventListener("click", closeAttachmentModal);
    }
 if (btnCloseDebugCalc) {
        btnCloseDebugCalc.addEventListener("click", closeDebugCalcModal);
    }
    if (btnCloseDebugCalcBottom) {
        btnCloseDebugCalcBottom.addEventListener("click", closeDebugCalcModal);
    }
    if (debugCalcModal) {
        debugCalcModal.addEventListener("click", (e) => {
            if (e.target === debugCalcModal) {
                closeDebugCalcModal();
            }
        });
    }
    btnProvisioning.addEventListener("click", openProvisioningModal);
    btnCloseProvisioning.addEventListener("click", closeProvisioningModal);
    btnCancelProvisioning.addEventListener("click", closeProvisioningModal);
    btnConfirmProvisioning.addEventListener("click", submitProvisioningRequest);

    btnCalculate.addEventListener("click", calculate);
    btnExport.addEventListener("click", exportExcel);
    // Init
    renderTypeChips();
    if (Array.isArray(storedScenarios) && storedScenarios.length > 0) {
        scenarios = storedScenarios.map(mapStoredScenario);
        activeScenarioId = scenarios[0]?.id || null;
    } else {
        scenarios = [createScenario("Escenario 1")];
        activeScenarioId = scenarios[0].id;
    }
    syncScenarioPanel();
})();
</script>
}